// _LICENSE_HEADER_
//
// Copyright (C) 2019 - 2025.
// Terms register on the GPL-3.0 license.
//
// This file can be redistributed and/or modified under the license terms.
//
// See top level LICENSE file for more details.
//
// This file can be used citing references in CITATION.cff file.

#ifndef __TEST_VEM_PCC_3D_LocalSpace_H
#define __TEST_VEM_PCC_3D_LocalSpace_H

#include <gmock/gmock-matchers.h>
#include <gmock/gmock.h>
#include <gtest/gtest.h>
#include <numbers>

#include "GeometryUtilities.hpp"
#include "VEM_PCC_2D_LocalSpace_Data.hpp"
#include "VEM_PCC_2D_ReferenceElement.hpp"
#include "VEM_PCC_3D_LocalSpace.hpp"
#include "VEM_PCC_3D_ReferenceElement.hpp"
#include "VEM_PCC_PerformanceAnalysis.hpp"
#include "VTKUtilities.hpp"

namespace Polydim
{
namespace UnitTesting
{

void Test_VEM_PCC_3D_Export_Dofs(const Polydim::VEM::PCC::VEM_PCC_3D_Polyhedron_Geometry &polyhedron,
                                 const std::vector<Polydim::VEM::PCC::VEM_PCC_2D_Polygon_Geometry> &polygonalFaces,
                                 const Polydim::VEM::PCC::VEM_PCC_3D_ReferenceElement_Data &vem_reference_element,
                                 const std::string &exportVtuFolder)
{
    Gedim::GeometryUtilitiesConfig geometryUtilitiesConfig;
    geometryUtilitiesConfig.Tolerance1D = polyhedron.Tolerance1D;
    geometryUtilitiesConfig.Tolerance2D = polyhedron.Tolerance2D;
    geometryUtilitiesConfig.Tolerance3D = polyhedron.Tolerance3D;
    Gedim::GeometryUtilities geometryUtilities(geometryUtilitiesConfig);

    const unsigned int num_vertices = polyhedron.Vertices.cols();
    const unsigned int num_edges = polyhedron.Edges.cols();
    const unsigned int num_faces = polyhedron.Faces.size();
    const unsigned int num_dofs = vem_reference_element.NumDofs0D * num_vertices + vem_reference_element.NumDofs1D * num_edges +
                                  num_faces * vem_reference_element.NumDofs2D + vem_reference_element.NumDofs3D;

    Eigen::MatrixXd dofs_coordinate = Eigen::MatrixXd::Zero(3, num_dofs);
    std::vector<double> dof_global_index_values(num_dofs);
    std::vector<double> dof_cell_index_values(num_dofs);
    std::vector<double> dof_dimension_values(num_dofs);

    unsigned int id_dofs = 0;
    if (vem_reference_element.NumDofs0D != 0)
    {
        for (unsigned int c = 0; c < num_vertices; ++c)
        {
            for (unsigned int loc_i = 0; loc_i < vem_reference_element.NumDofs0D; ++loc_i)
            {
                dof_cell_index_values[id_dofs] = c;
                dof_dimension_values[id_dofs] = 0;
                dofs_coordinate.col(id_dofs) = polyhedron.Vertices.col(c);
                dof_global_index_values[id_dofs] = id_dofs;
                id_dofs++;
            }
        }
    }

    if (vem_reference_element.NumDofs1D != 0)
    {
        for (unsigned int c = 0; c < num_edges; ++c)
        {
            const std::vector<double> local_edge_coordinates =
                geometryUtilities.EquispaceCoordinates(vem_reference_element.NumDofs1D, 0.0, 1.0, false);
            const Eigen::Vector3d edge_origin = polyhedron.Vertices.col(polyhedron.Edges(0, c));
            const Eigen::Vector3d edge_tangent = polyhedron.Vertices.col(polyhedron.Edges(1, c)) - edge_origin;

            for (unsigned int loc_i = 0; loc_i < vem_reference_element.NumDofs1D; ++loc_i)
            {
                dof_cell_index_values[id_dofs] = c;
                dof_dimension_values[id_dofs] = 1;
                dofs_coordinate.col(id_dofs) = edge_origin + local_edge_coordinates[loc_i] * edge_tangent;
                dof_global_index_values[id_dofs] = id_dofs;
                id_dofs++;
            }
        }
    }

    if (vem_reference_element.NumDofs2D != 0)
    {
        for (unsigned int c = 0; c < num_faces; c++)
        {
            const auto local_polygon_coordinates =
                geometryUtilities.EquispaceCoordinates(vem_reference_element.NumDofs2D + 1, 0.0, 1.0, true);
            const Eigen::Vector3d polygon_centroid = polygonalFaces[c].Centroid;
            const auto polygonCentroidEdgesDistance =
                geometryUtilities.PolygonCentroidEdgesDistance(polygonalFaces[c].Vertices,
                                                               polygonalFaces[c].Centroid,
                                                               polygonalFaces[c].EdgesNormal);

            double circle_diameter = 0.0;
            if (vem_reference_element.NumDofs2D > 1)
                circle_diameter = 0.5 * geometryUtilities.PolygonInRadius(polygonCentroidEdgesDistance);

            for (unsigned int loc_i = 0; loc_i < vem_reference_element.NumDofs2D; ++loc_i)
            {
                dof_cell_index_values[id_dofs] = 0;
                dof_dimension_values[id_dofs] = 2;
                dofs_coordinate.col(id_dofs) = geometryUtilities.RotatePointsFrom2DTo3D(
                    polygon_centroid +
                        circle_diameter * Eigen::Vector3d(cos(2.0 * std::numbers::pi * local_polygon_coordinates.at(loc_i)),
                                                          sin(2.0 * std::numbers::pi * local_polygon_coordinates.at(loc_i)),
                                                          0.0),
                    polyhedron.FacesRotationMatrix[c],
                    polyhedron.FacesTranslation[c]);
                dof_global_index_values[id_dofs] = id_dofs;
                id_dofs++;
            }
        }
    }

    if (vem_reference_element.NumDofs3D != 0)
    {
        const auto faces3DVertices = geometryUtilities.PolyhedronFaceVertices(polyhedron.Vertices, polyhedron.Faces);

        const auto local_polyhedron_coordinates = geometryUtilities.fibonacci_sphere(vem_reference_element.NumDofs3D);
        const Eigen::Vector3d polyhedron_centroid = polyhedron.Centroid;
        const auto polyhedron_centroid_faces_distance =
            geometryUtilities.PolyhedronCentroidFacesDistance(polyhedron_centroid, polyhedron.FacesNormal, faces3DVertices);
        const double polyhedron_in_radius = geometryUtilities.PolyhedronInRadius(polyhedron_centroid_faces_distance);

        double sphere_diameter = 0.0;
        if (vem_reference_element.NumDofs3D > 0)
            sphere_diameter = 0.5 * polyhedron_in_radius;

        for (unsigned int loc_i = 0; loc_i < vem_reference_element.NumDofs3D; ++loc_i)
        {
            dof_cell_index_values[id_dofs] = 0;
            dof_dimension_values[id_dofs] = 3;
            dofs_coordinate.col(id_dofs) = polyhedron_centroid + sphere_diameter * local_polyhedron_coordinates.col(loc_i);
            dof_global_index_values[id_dofs] = id_dofs;
            id_dofs++;
        }
    }

    {
        Gedim::VTKUtilities exporter;
        exporter.AddPoints(dofs_coordinate,
                           {{"cell_dimension",
                             Gedim::VTPProperty::Formats::Points,
                             static_cast<unsigned int>(dof_dimension_values.size()),
                             dof_dimension_values.data()},
                            {"cell_index",
                             Gedim::VTPProperty::Formats::Points,
                             static_cast<unsigned int>(dof_cell_index_values.size()),
                             dof_cell_index_values.data()},
                            {"dof_global_index",
                             Gedim::VTPProperty::Formats::Points,
                             static_cast<unsigned int>(dof_global_index_values.size()),
                             dof_global_index_values.data()}});

        exporter.Export(exportVtuFolder + "/dofs_" + std::to_string(vem_reference_element.Order) + ".vtu");
    }
}

struct Test_VEM_PCC_2D_PolygonalFaces_Geometry final
{
    Eigen::MatrixXd Vertices;
    Eigen::Vector3d Centroid;
    double Measure;
    double Diameter;
    std::vector<Eigen::Matrix3d> TriangulationVertices;
    Eigen::VectorXd EdgesLength;
    std::vector<bool> EdgesDirection;
    Eigen::MatrixXd EdgesTangent;
    Eigen::MatrixXd EdgesNormal;
};

struct Test_VEM_PCC_3D_Polyhedron_Geometry final
{
    std::vector<Test_VEM_PCC_2D_PolygonalFaces_Geometry> PolygonalFaces;

    Eigen::MatrixXd Vertices;
    Eigen::MatrixXi Edges;
    std::vector<Eigen::MatrixXi> Faces;
    Eigen::Vector3d Centroid;
    double Measure;
    double Diameter;
    std::vector<Eigen::MatrixXd> TetrahedronVertices;

    std::vector<double> FacesMeasure;
    std::vector<Eigen::Matrix3d> FacesRotationMatrix;
    std::vector<Eigen::Vector3d> FacesTranslation;
    std::vector<Eigen::Vector3d> FacesNormals;
    std::vector<bool> FacesNormalDirection;

    std::vector<bool> EdgesDirection;
    Eigen::MatrixXd EdgesTangent;
};

Test_VEM_PCC_3D_Polyhedron_Geometry Test_VEM_PCC_3D_Geometry(const Gedim::GeometryUtilities &geometry_utilities)
{
    Test_VEM_PCC_3D_Polyhedron_Geometry result;

    const Eigen::Vector3d origin = Eigen::Vector3d(0.0, 0.0, 0.0);
    const Eigen::Vector3d length = Eigen::Vector3d(1.0, 0.0, 0.0);
    const Eigen::Vector3d height = Eigen::Vector3d(0.0, 0.0, 1.0);
    const Eigen::Vector3d width = Eigen::Vector3d(0.0, 1.0, 0.0);
    Gedim::GeometryUtilities::Polyhedron cube = geometry_utilities.CreateParallelepipedWithOrigin(origin, length, height, width);

    result.Vertices = cube.Vertices;
    result.Edges = cube.Edges;
    result.Faces = cube.Faces;

    result.Measure = 1.0e+00;
    result.Diameter = sqrt(3.0);
    result.Centroid << 0.5, 0.5, 0.5;
    result.EdgesTangent = geometry_utilities.PolyhedronEdgeTangents(result.Vertices, result.Edges);
    result.EdgesDirection.resize(12, true);

    const std::vector<Eigen::MatrixXd> facesVertices = geometry_utilities.PolyhedronFaceVertices(result.Vertices, result.Faces);
    result.FacesTranslation = geometry_utilities.PolyhedronFaceTranslations(facesVertices);
    result.FacesNormals = geometry_utilities.PolyhedronFaceNormals(facesVertices);
    result.FacesRotationMatrix =
        geometry_utilities.PolyhedronFaceRotationMatrices(facesVertices, result.FacesNormals, result.FacesTranslation);
    result.FacesNormalDirection =
        geometry_utilities.PolyhedronFaceNormalDirections(facesVertices, result.Centroid, result.FacesNormals);

    const unsigned int numFaces = result.Faces.size();
    result.PolygonalFaces.resize(numFaces);

    std::vector<std::vector<bool>> facesEdgeDirections =
        geometry_utilities.PolyhedronFaceEdgeDirections(result.Vertices, result.Edges, result.Faces);

    for (unsigned int f = 0; f < numFaces; f++)
    {
        result.PolygonalFaces[f].Vertices = geometry_utilities.RotatePointsFrom3DTo2D(facesVertices[f],
                                                                                      result.FacesRotationMatrix[f].transpose(),
                                                                                      result.FacesTranslation[f]);
        std::vector<unsigned int> facesTriangulation =
            geometry_utilities.PolygonTriangulationByFirstVertex(result.PolygonalFaces[f].Vertices);
        result.PolygonalFaces[f].TriangulationVertices =
            geometry_utilities.ExtractTriangulationPoints(result.PolygonalFaces[f].Vertices, facesTriangulation);
        result.PolygonalFaces[f].Measure = geometry_utilities.PolygonArea(result.PolygonalFaces[f].Vertices);
        result.PolygonalFaces[f].Diameter = geometry_utilities.PolygonDiameter(result.PolygonalFaces[f].Vertices);
        result.PolygonalFaces[f].Centroid =
            geometry_utilities.PolygonCentroid(result.PolygonalFaces[f].Vertices, result.PolygonalFaces[f].Measure);

        result.PolygonalFaces[f].EdgesLength = geometry_utilities.PolygonEdgeLengths(result.PolygonalFaces[f].Vertices);
        result.PolygonalFaces[f].EdgesNormal = geometry_utilities.PolygonEdgeNormals(result.PolygonalFaces[f].Vertices);
        result.PolygonalFaces[f].EdgesTangent = geometry_utilities.PolygonEdgeTangents(result.PolygonalFaces[f].Vertices);
        result.PolygonalFaces[f].EdgesDirection = facesEdgeDirections[f];
    }

    std::vector<std::vector<unsigned int>> facesTriangulation3D =
        geometry_utilities.PolyhedronFaceTriangulationsByFirstVertex(result.Faces, facesVertices);

    std::vector<unsigned int> polyhedronTetrahedrons =
        geometry_utilities.PolyhedronTetrahedronsByFaceTriangulations(result.Vertices,
                                                                      result.Faces,
                                                                      facesTriangulation3D,
                                                                      result.Centroid);

    result.TetrahedronVertices =
        geometry_utilities.ExtractTetrahedronPoints(result.Vertices, result.Centroid, polyhedronTetrahedrons);

    return result;
}

std::vector<Eigen::MatrixXd> Test_VEM_PCC_3D_RefPiNabla()
{
    std::vector<Eigen::MatrixXd> refPiNabla(3);
    refPiNabla[0] = (Eigen::MatrixXd(4, 8) << 1.2499999999999986e-01,
                     1.2499999999999994e-01,
                     1.2499999999999997e-01,
                     1.2499999999999990e-01,
                     1.2499999999999990e-01,
                     1.2499999999999997e-01,
                     1.2500000000000000e-01,
                     1.2499999999999994e-01,
                     -4.3301270189222024e-01,
                     4.3301270189222024e-01,
                     4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     -4.3301270189222024e-01,
                     4.3301270189222024e-01,
                     4.3301270189222024e-01,
                     -4.3301270189222024e-01,
                     -4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     -4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     4.3301270189222013e-01,
                     4.3301270189222013e-01)
                        .finished();

    refPiNabla[1] = (Eigen::MatrixXd(10, 27) << -2.2209203877007786e-18,
                     -3.3034284942917704e-19,
                     1.2722434867759595e-18,
                     1.1367182152152711e-18,
                     -3.7489678245475356e-18,
                     -1.3840518358135260e-18,
                     2.6579893884839968e-18,
                     1.3976043629695971e-18,
                     -2.3784685158900800e-18,
                     3.7540500222310614e-18,
                     -8.7413800156643699e-19,
                     -1.1519648082658492e-18,
                     3.6795111228726853e-18,
                     -5.0144350477454676e-19,
                     -3.0289898193813815e-18,
                     -7.3048121371210907e-18,
                     -5.6785088783928379e-18,
                     4.3774662714102311e-18,
                     6.0308745844506238e-18,
                     -1.7618285302889589e-19,
                     -2.5000000000000022e-01,
                     -2.5000000000000022e-01,
                     -2.5000000000000033e-01,
                     -2.5000000000000033e-01,
                     -2.5000000000000044e-01,
                     -2.5000000000000044e-01,
                     2.5000000000000022e+00,
                     -9.2495997840169582e-18,
                     9.2495997840169566e-18,
                     -1.6364676540953089e-17,
                     1.6364676540953092e-17,
                     6.4848842441789450e-18,
                     -6.4848842441789480e-18,
                     -1.1851684997982172e-17,
                     1.1851684997982172e-17,
                     -3.6119231246724168e-34,
                     -1.1628068299907049e-17,
                     3.6071623725515865e-34,
                     1.1628068299907050e-17,
                     1.7552297975486111e-34,
                     2.8541622190680941e-17,
                     -1.7504690454277808e-34,
                     -2.8541622190680947e-17,
                     -6.2937936112783582e-17,
                     6.2937936112783582e-17,
                     -4.4723339615027083e-17,
                     4.4723339615027083e-17,
                     -1.7931105661500923e-34,
                     1.7984664122860263e-34,
                     -1.7320508075688805e+00,
                     1.7320508075688805e+00,
                     -7.1811214073566230e-32,
                     6.8260288085441957e-32,
                     1.7856809780836283e-16,
                     -9.0056542952077304e-18,
                     -1.2908782116155559e-17,
                     1.2908782116155559e-17,
                     9.0056542952077274e-18,
                     1.5246593050577464e-18,
                     7.7046116882251236e-18,
                     -7.7046116882251205e-18,
                     -1.5246593050577458e-18,
                     1.2197274440461894e-18,
                     3.8663258161292828e-34,
                     -1.2197274440461923e-18,
                     -3.8758473203709433e-34,
                     -5.1228552649940115e-18,
                     7.7499093586965786e-34,
                     5.1228552649940131e-18,
                     -7.7403878544549181e-34,
                     -1.5124620306172802e-17,
                     1.5124620306172802e-17,
                     -1.5124620306172793e-17,
                     1.5124620306172793e-17,
                     -1.9286996478908606e-34,
                     1.7867697252886071e-34,
                     -1.6482348019291922e-32,
                     1.5371545530699197e-32,
                     -1.7320508075688805e+00,
                     1.7320508075688799e+00,
                     5.7083244381361907e-16,
                     -1.6913553890773872e-17,
                     -2.0816681711721704e-17,
                     1.5612511283791267e-17,
                     9.4325589006238932e-18,
                     1.6913553890773872e-17,
                     2.0816681711721704e-17,
                     -1.5612511283791267e-17,
                     -9.4325589006238917e-18,
                     -3.0411870938218406e-17,
                     1.5124620306172796e-17,
                     2.6508743117270580e-17,
                     -1.5124620306172796e-17,
                     3.0411870938218406e-17,
                     -1.5124620306172796e-17,
                     -2.6508743117270580e-17,
                     1.5124620306172796e-17,
                     -6.1874900220415903e-34,
                     2.4741033677939793e-34,
                     -1.3124798503113933e-34,
                     5.0258665045590049e-34,
                     -1.7320508075688801e+00,
                     1.7320508075688801e+00,
                     -1.2519150799106312e-32,
                     1.2584492121964707e-32,
                     -6.7400660569506433e-32,
                     6.1865393588018595e-32,
                     1.4636729328554437e-18,
                     -1.4636729328554313e-17,
                     -2.0491421059976025e-17,
                     -3.6225905088171917e-17,
                     -4.2812433286021344e-17,
                     8.8186294204539705e-17,
                     8.1599766006690265e-17,
                     8.7820375971325798e-18,
                     2.9273458657108654e-18,
                     1.2800472264882378e-34,
                     -4.6105697384946070e-17,
                     -1.3228939955757101e-34,
                     -4.7569370317801501e-17,
                     -5.5165215200120732e-35,
                     1.3978076508769363e-16,
                     5.9449892108867959e-35,
                     1.4124443802054907e-16,
                     3.5859986854958047e-17,
                     1.0977546996415742e-17,
                     -9.2943231236319868e-17,
                     -1.1782567109486217e-16,
                     -1.6137995095350745e-33,
                     1.6186197710574152e-33,
                     9.0000000000000036e+00,
                     9.0000000000000036e+00,
                     2.8172091675014408e-32,
                     -2.6779036095057962e-32,
                     -1.8000000000000000e+01,
                     4.9999999999999911e-01,
                     -4.9999999999999906e-01,
                     4.9999999999999895e-01,
                     -4.9999999999999906e-01,
                     4.9999999999999911e-01,
                     -4.9999999999999906e-01,
                     4.9999999999999906e-01,
                     -4.9999999999999911e-01,
                     2.2686930459259183e-17,
                     -7.7940583674551675e-17,
                     -2.2686930459259183e-17,
                     7.7940583674551675e-17,
                     -1.0977546996415735e-17,
                     -1.5624708558231728e-16,
                     1.0977546996415735e-17,
                     1.5624708558231728e-16,
                     1.9999999999999976e+00,
                     -1.9999999999999976e+00,
                     1.9999999999999976e+00,
                     -1.9999999999999976e+00,
                     4.1029857319577741e-32,
                     -4.1285331180261795e-32,
                     3.3229033403900679e-15,
                     -3.0989613816631869e-15,
                     4.5288310688459624e-15,
                     -4.3048891101190815e-15,
                     -4.4788391745376208e-16,
                     8.4069714080883830e-17,
                     -8.5075989222221926e-18,
                     3.4121875247192241e-17,
                     2.1314737084707232e-17,
                     1.4362290653643926e-17,
                     -7.8215022349462106e-17,
                     -3.8878812278972410e-17,
                     -2.8267183515770523e-17,
                     1.4819688445161241e-16,
                     -4.9193446758554226e-34,
                     -5.4521816748864798e-17,
                     7.1902234374914596e-34,
                     -1.2477811752592549e-16,
                     -9.6485568138851950e-34,
                     7.7940583674551700e-17,
                     7.3776780522491564e-34,
                     1.9979135533476638e-16,
                     -1.9979135533476638e-16,
                     -9.2943231236319905e-17,
                     9.2943231236319905e-17,
                     4.5999486602196590e-32,
                     -4.2614457948132868e-32,
                     2.0670485630751326e-32,
                     -1.9277430050794880e-32,
                     9.0000000000000053e+00,
                     9.0000000000000053e+00,
                     -1.8000000000000007e+01,
                     4.9999999999999917e-01,
                     -4.9999999999999911e-01,
                     -4.9999999999999900e-01,
                     4.9999999999999911e-01,
                     -4.9999999999999900e-01,
                     4.9999999999999889e-01,
                     4.9999999999999911e-01,
                     -4.9999999999999917e-01,
                     3.5859986854958041e-17,
                     -1.9999999999999976e+00,
                     -2.4150603392114596e-17,
                     1.9999999999999976e+00,
                     -3.5859986854958041e-17,
                     1.9999999999999976e+00,
                     2.4150603392114596e-17,
                     -1.9999999999999976e+00,
                     8.9649967137395099e-17,
                     -8.9649967137395099e-17,
                     6.6231200211708215e-17,
                     -6.6231200211708215e-17,
                     4.4102735612846710e-15,
                     -4.4234466176803698e-15,
                     2.5239078777190194e-15,
                     -2.5370809341147182e-15,
                     7.0357116983794837e-32,
                     -6.6014061352165929e-32,
                     2.6346112791397736e-17,
                     4.9999999999999911e-01,
                     4.9999999999999911e-01,
                     -4.9999999999999911e-01,
                     -4.9999999999999922e-01,
                     -4.9999999999999906e-01,
                     -4.9999999999999906e-01,
                     4.9999999999999906e-01,
                     4.9999999999999911e-01,
                     1.9999999999999976e+00,
                     -7.3183646642770586e-19,
                     -1.9999999999999976e+00,
                     2.4150603392114602e-17,
                     -1.9999999999999976e+00,
                     7.3183646642770172e-19,
                     1.9999999999999976e+00,
                     -2.4150603392114602e-17,
                     1.0977546996415737e-17,
                     1.2441219929271159e-17,
                     -1.2441219929271163e-17,
                     -1.0977546996415732e-17,
                     4.7437638399594775e-15,
                     -4.3946778454734572e-15,
                     1.4484335574505218e-32,
                     -1.4648224466264800e-32,
                     4.2506760202552145e-15,
                     -3.9015900257691942e-15,
                     -6.9817198897204068e-16,
                     3.3938916130585287e-17,
                     4.0891362561648585e-17,
                     -5.1502991324850453e-17,
                     -3.5036670830226861e-17,
                     2.4608001183631937e-17,
                     3.0828611148267515e-17,
                     -4.2172076377897105e-17,
                     -2.4973919416845794e-17,
                     -1.5734484028195902e-17,
                     -1.0465261469916329e-16,
                     3.9153250953882791e-17,
                     1.0465261469916329e-16,
                     -5.4521816748864767e-17,
                     -1.0611628763201872e-16,
                     7.7940583674551663e-17,
                     1.0611628763201872e-16,
                     7.3642884369093206e-35,
                     1.5344499179451035e-34,
                     -1.4487563797701592e-34,
                     -8.2212238186587628e-35,
                     9.0000000000000000e+00,
                     9.0000000000000000e+00,
                     -9.2354391140948043e-34,
                     9.2836417293182107e-34,
                     4.1218096271351948e-32,
                     -3.7833067617288237e-32,
                     -1.7999999999999996e+01)
                        .finished();

    refPiNabla[2] = (Eigen::MatrixXd(20, 54) << -2.4461155381959153e-18,
                     -4.1227487843283782e-19,
                     4.2283969639491155e-19,
                     7.2976789836378207e-19,
                     -5.6514123153363603e-19,
                     -1.0651929454764873e-18,
                     5.7586679065841598e-19,
                     -1.5901110088763318e-18,
                     -4.4840581644000860e-18,
                     4.1907624800716432e-18,
                     -2.4646817035313358e-18,
                     -8.9379181801503816e-19,
                     3.4781970805757393e-18,
                     3.5336104537876951e-18,
                     2.0063766563032653e-18,
                     -2.6433434228160221e-18,
                     2.5391249767188207e-18,
                     3.1748904884663678e-18,
                     -4.6491194517366870e-18,
                     1.9928221193247183e-18,
                     3.4269610462267176e-18,
                     8.4944029380087726e-18,
                     2.0174483073810640e-18,
                     -3.4972269805512585e-18,
                     -8.2497050564516375e-18,
                     -6.2833853542339724e-18,
                     -8.3353735088743980e-18,
                     -8.5940747894273905e-18,
                     -5.9952042491643853e-18,
                     -5.6551878056749785e-18,
                     -3.4812269066299359e-18,
                     -5.0409707941655353e-18,
                     -2.5000000000000000e-01,
                     5.6543832082673245e-17,
                     2.3902055863749254e-16,
                     -2.5000000000000006e-01,
                     5.7748100048039693e-17,
                     2.0293530664854950e-16,
                     -2.5000000000000006e-01,
                     -7.6792440488153356e-17,
                     1.6454069483731495e-17,
                     -2.5000000000000000e-01,
                     -7.9040272594720820e-17,
                     1.7658337449097897e-17,
                     -2.5000000000000028e-01,
                     2.4244308368200175e-19,
                     2.4333541510733671e-17,
                     -2.5000000000000022e-01,
                     -8.2670030655807141e-17,
                     1.4307235975272075e-16,
                     2.5000000000000031e+00,
                     -1.1970856969578751e-15,
                     -1.3516951565488930e-15,
                     4.6675363076030018e-16,
                     1.2028130608117192e-02,
                     -1.2028130608117187e-02,
                     -1.2028130608117202e-02,
                     1.2028130608117200e-02,
                     1.2028130608117190e-02,
                     -1.2028130608117187e-02,
                     -1.2028130608117207e-02,
                     1.2028130608117211e-02,
                     1.6835180213968772e-17,
                     2.0089446959191982e-17,
                     -3.0070326520293036e-02,
                     -3.0070326520293008e-02,
                     1.3671339326017549e-17,
                     1.9517526889838929e-17,
                     3.0070326520293015e-02,
                     3.0070326520293015e-02,
                     1.9718699454747033e-17,
                     1.7379228292558468e-17,
                     -3.0070326520292998e-02,
                     -3.0070326520292987e-02,
                     8.1692323889782199e-18,
                     1.7264706014722736e-17,
                     3.0070326520292994e-02,
                     3.0070326520292966e-02,
                     3.0070326520293039e-02,
                     3.0070326520292998e-02,
                     -3.0070326520293018e-02,
                     -3.0070326520292994e-02,
                     -3.0070326520293050e-02,
                     -3.0070326520293081e-02,
                     3.0070326520293029e-02,
                     3.0070326520293070e-02,
                     1.1050318846285412e-15,
                     -6.1237243569579549e+00,
                     9.5416400489951155e-17,
                     9.9379012906112526e-16,
                     -6.1237243569579549e+00,
                     7.7314479164131268e-17,
                     2.3094010767584767e+00,
                     -2.9455830151460169e-15,
                     7.1967262311175112e-17,
                     -2.3094010767584781e+00,
                     1.4979236855803046e-15,
                     7.2589605232626832e-16,
                     7.8406040926836976e-16,
                     -6.1237243569579487e+00,
                     -2.1596869942317657e-17,
                     1.0480273864129537e-15,
                     -6.1237243569579496e+00,
                     8.2273953136481742e-17,
                     1.1092729751472476e-15,
                     1.1999999999999957e+02,
                     -1.0534797715346853e-15,
                     1.0712174029673843e-16,
                     1.2028130608117223e-02,
                     1.2028130608117213e-02,
                     -1.2028130608117221e-02,
                     -1.2028130608117223e-02,
                     1.2028130608117207e-02,
                     1.2028130608117223e-02,
                     -1.2028130608117218e-02,
                     -1.2028130608117237e-02,
                     3.0070326520292952e-02,
                     3.0070326520292893e-02,
                     6.6401806261002290e-18,
                     6.6903887642920726e-18,
                     -3.0070326520292942e-02,
                     -3.0070326520293018e-02,
                     7.3229864895785133e-19,
                     1.1683820818312584e-17,
                     3.0070326520292873e-02,
                     3.0070326520292987e-02,
                     6.8147649110780359e-18,
                     3.8677040932764474e-18,
                     -3.0070326520293015e-02,
                     -3.0070326520292914e-02,
                     1.0593488644414238e-18,
                     5.0494878846525956e-18,
                     3.0070326520293143e-02,
                     3.0070326520293060e-02,
                     3.0070326520293140e-02,
                     3.0070326520293202e-02,
                     -3.0070326520293161e-02,
                     -3.0070326520293185e-02,
                     -3.0070326520293150e-02,
                     -3.0070326520293091e-02,
                     9.2655117693445203e-16,
                     -1.9224242462910775e-17,
                     -6.1237243569579416e+00,
                     1.3465424243553158e-15,
                     -3.2474727587505653e-17,
                     -6.1237243569579443e+00,
                     1.1405323912373774e-15,
                     -6.1237243569579647e+00,
                     7.7285705754551208e-16,
                     8.4454990336114493e-16,
                     -6.1237243569579647e+00,
                     7.5960657242091695e-16,
                     2.3094010767584736e+00,
                     -5.6146635396957866e-15,
                     -6.1783913773192175e-15,
                     -2.3094010767584772e+00,
                     4.5791307077816606e-15,
                     3.2721945233846700e-15,
                     3.3488296670597801e-16,
                     -1.0534797715346770e-15,
                     1.1999999999999957e+02,
                     -1.2011952222325727e-15,
                     1.2028130608117218e-02,
                     1.2028130608117228e-02,
                     1.2028130608117233e-02,
                     1.2028130608117249e-02,
                     -1.2028130608117239e-02,
                     -1.2028130608117249e-02,
                     -1.2028130608117228e-02,
                     -1.2028130608117249e-02,
                     3.0070326520293018e-02,
                     3.0070326520292956e-02,
                     3.0070326520293223e-02,
                     3.0070326520293213e-02,
                     3.0070326520293036e-02,
                     3.0070326520292932e-02,
                     3.0070326520293119e-02,
                     3.0070326520293192e-02,
                     -3.0070326520293060e-02,
                     -3.0070326520292998e-02,
                     -3.0070326520293237e-02,
                     -3.0070326520293268e-02,
                     -3.0070326520293036e-02,
                     -3.0070326520292932e-02,
                     -3.0070326520293150e-02,
                     -3.0070326520293206e-02,
                     7.2545666393952488e-18,
                     -6.5507974902188407e-18,
                     -5.1797591342124475e-19,
                     4.4443642468578801e-18,
                     -1.1516415274715396e-17,
                     -2.8330546547277502e-18,
                     -2.6910060460414487e-18,
                     -1.9759992843846692e-17,
                     2.3094010767584860e+00,
                     -4.2009876898095123e-15,
                     -3.0217770212226473e-15,
                     -2.3094010767584883e+00,
                     2.3120669933694891e-15,
                     6.2153915519478253e-15,
                     9.5307546613551807e-16,
                     -8.4893745732438133e-16,
                     -6.1237243569579753e+00,
                     1.2218023493313968e-15,
                     -8.7771064320062938e-16,
                     -6.1237243569579753e+00,
                     1.4191040020012397e-15,
                     -1.6262853095264715e-16,
                     -6.1237243569579487e+00,
                     1.0227820029986674e-15,
                     -3.5276603990982491e-17,
                     -6.1237243569579514e+00,
                     1.2911249361210290e-15,
                     1.0712174029673196e-16,
                     -1.2011952222325672e-15,
                     1.1999999999999987e+02,
                     -3.9211047807608917e-17,
                     -3.4868166896495705e-17,
                     -8.5572886847630718e-17,
                     -8.6985963735824080e-17,
                     -4.9450941208282722e-17,
                     -4.8037864320089355e-17,
                     -3.3972598835162595e-17,
                     -3.8315479746275813e-17,
                     -5.4593674633342612e-19,
                     5.4593674633341966e-19,
                     -1.5990459565923201e-16,
                     -2.0051563833899548e-16,
                     -5.4593674633342746e-19,
                     5.4593674633341909e-19,
                     -2.3934101823760982e-16,
                     -1.7456760975178233e-16,
                     5.4593674633342275e-19,
                     -5.4593674633342352e-19,
                     -1.3243190670766943e-16,
                     -2.9088038289624452e-16,
                     5.4593674633342313e-19,
                     -5.4593674633342429e-19,
                     -2.9090666766024046e-16,
                     -1.3027444448633173e-16,
                     -1.7453574817423887e-17,
                     1.1448084399496149e-17,
                     -9.0621809781966833e-19,
                     2.5811694133766647e-17,
                     -8.9022749840833951e-17,
                     -2.0601921436817291e-17,
                     -1.0338635957510445e-16,
                     -3.7149278156421523e-17,
                     8.8370942056490665e-18,
                     3.4944492968930389e-16,
                     3.4986097934247346e-32,
                     -8.8370942056490080e-18,
                     -5.6644861429703551e-16,
                     -8.0703345135816996e-33,
                     8.9999999999999911e+00,
                     2.8539971701119480e-15,
                     -2.0710541724640714e-15,
                     8.9999999999999929e+00,
                     3.4906026284366570e-15,
                     -2.9869477164504105e-15,
                     1.9097225303479807e-18,
                     1.2554267583023033e-15,
                     1.6072909099110786e-31,
                     -1.9097225303484448e-18,
                     1.8920322166270127e-15,
                     8.7406746885449323e-32,
                     -1.7999999999999993e+01,
                     -3.3774422537472534e-14,
                     -1.9846418705531719e-16,
                     -9.1837776932741675e-16,
                     1.2705153747311896e-17,
                     -3.8705878526006225e-17,
                     1.8664166749652978e-17,
                     6.1618976345236305e-18,
                     -2.7995081696606345e-17,
                     1.6525032824735530e-17,
                     2.3154833107646181e-17,
                     1.1992596215858043e-18,
                     5.7969447815184552e-17,
                     1.2863526480758061e-17,
                     -8.0749508426597827e-17,
                     -3.9302769424309914e-17,
                     -3.6771208616233850e-17,
                     -5.9190199491401130e-17,
                     3.7586870114232169e-17,
                     5.7078515123688623e-17,
                     3.9698554481944694e-17,
                     6.5044891222822842e-17,
                     -5.2955435909214237e-17,
                     -9.1474829045791264e-17,
                     -4.6991900818768801e-17,
                     -2.9695765208595542e-17,
                     9.3190728355868941e-17,
                     5.4671335219291933e-17,
                     -8.7814062770044467e-17,
                     -1.7975751795584472e-16,
                     6.5248911416394257e-17,
                     2.8389148510916582e-17,
                     1.6219344276157962e-16,
                     1.7563443874137038e-16,
                     -1.1620952448224244e-16,
                     -2.4266069296442183e-17,
                     7.0479623671061950e-18,
                     3.9325072941043193e-16,
                     3.4944492968930241e-16,
                     -7.0479623671062551e-18,
                     2.4792595800274574e-16,
                     -5.6644861429703650e-16,
                     5.2035278460182253e-15,
                     -2.5455844122715689e+01,
                     3.5260084167704632e-15,
                     -4.7533798094964535e-15,
                     2.5455844122715696e+01,
                     -3.1765710938295529e-15,
                     3.6690436696764174e-15,
                     -2.5455844122715682e+01,
                     5.8224782952242375e-16,
                     -3.2188956331546456e-15,
                     2.5455844122715686e+01,
                     -3.3364571446391546e-16,
                     -9.0029607304354525e-16,
                     -4.8968087404131267e-15,
                     -1.4516262729601647e-14,
                     -7.3244573457969923e-16,
                     5.1022672220191894e-17,
                     4.2766678875651709e-17,
                     4.3454064736015911e-17,
                     5.0339442926534747e-17,
                     2.9363663673541818e-17,
                     2.4307876649092246e-17,
                     2.2160974422579667e-17,
                     3.0051049533905988e-17,
                     9.3179513441969187e-17,
                     -4.5798341112200726e-17,
                     7.6737349997575311e-19,
                     -7.6737349997573867e-19,
                     -6.6139707218812950e-17,
                     7.1516622536693661e-17,
                     7.6737349997575455e-19,
                     -7.6737349997575436e-19,
                     -1.5633857857521263e-16,
                     -7.1516622536693673e-17,
                     -7.6737349997576235e-19,
                     7.6737349997573944e-19,
                     -6.0978708919149717e-17,
                     -1.6936158001754771e-16,
                     -7.6737349997576187e-19,
                     7.6737349997575167e-19,
                     2.7385859562057388e-16,
                     2.0806438770917554e-16,
                     3.2554324887081061e-16,
                     2.7424362215377445e-16,
                     3.1153950345450259e-16,
                     2.6477304367022487e-16,
                     2.3804190434562649e-16,
                     1.9406064229286753e-16,
                     -6.5066112696605794e-17,
                     4.2484822266621568e-32,
                     3.9325072941043124e-16,
                     6.5066112696605634e-17,
                     9.2584510809624955e-32,
                     2.4792595800274737e-16,
                     4.3077844145917950e-17,
                     9.4567579235261493e-16,
                     -1.3576202523037158e-30,
                     -4.3077844145918314e-17,
                     1.5822812506773234e-15,
                     -1.3765833980501029e-30,
                     8.9999999999999982e+00,
                     1.3219852783006923e-15,
                     -3.1562343236029696e-15,
                     8.9999999999999982e+00,
                     4.8625178354105764e-15,
                     -8.8752256233241388e-15,
                     -1.8000000000000007e+01,
                     -4.4767808844757924e-15,
                     2.3428888638533874e-15,
                     6.7618687824914126e-15,
                     -1.8972551210264075e-17,
                     5.0449032584227715e-18,
                     -7.0839454962816809e-18,
                     -1.8012137128409794e-17,
                     -6.6379882492379808e-18,
                     3.1734070873929453e-17,
                     3.2877444072390678e-17,
                     -7.2404126577059180e-18,
                     4.3883435788229923e-17,
                     1.0428466552104528e-17,
                     1.2050627076465576e-16,
                     9.1023303887997639e-17,
                     3.4126640468030787e-17,
                     2.8481456956158576e-17,
                     -1.0579819219104245e-16,
                     -1.3894034139983916e-16,
                     -4.5104187464446513e-17,
                     -1.1649218228321120e-17,
                     7.4329224134650694e-17,
                     1.8138685645264666e-16,
                     -3.2905888791814191e-17,
                     -2.7260705279941985e-17,
                     -9.3428321506830286e-17,
                     -9.7609832085847091e-17,
                     -4.6158735165268918e-18,
                     3.8771986222257820e-17,
                     4.4842532177602927e-18,
                     -3.8903606521024410e-17,
                     -6.9370999326521803e-18,
                     -1.6607384009876836e-17,
                     7.0687202314187987e-18,
                     1.6739004308643445e-17,
                     2.6081350806496083e-15,
                     -2.5455844122715678e+01,
                     -1.9400167163309947e-16,
                     -3.2557696164473295e-15,
                     2.5455844122715682e+01,
                     4.4260378669160763e-16,
                     3.9111147539429592e-15,
                     -3.4267506299140388e-15,
                     -2.5455844122715696e+01,
                     -4.5587492897406788e-15,
                     3.4535546763843411e-15,
                     2.5455844122715696e+01,
                     3.2456927399592394e-18,
                     1.0524532420174264e-15,
                     1.2554267583023027e-15,
                     -3.2456927399601623e-18,
                     9.0712847060974007e-16,
                     1.8920322166270123e-15,
                     1.2952690715954414e-15,
                     -3.0944456449403952e-14,
                     -3.3730228388205533e-16,
                     -1.8790923273721960e-14,
                     -2.5704281280440793e-17,
                     -1.0610106404609684e-16,
                     3.2795695072874375e-17,
                     -6.0049478999162843e-17,
                     -5.3835993482671190e-17,
                     3.9923976172400667e-17,
                     3.4120400644359524e-17,
                     1.2714136245589366e-16,
                     -1.8377402866009733e-16,
                     -2.0230331303976848e-16,
                     -4.8643808944778440e-17,
                     1.4527499886983410e-17,
                     1.6860286684655477e-17,
                     -8.2555258928651426e-18,
                     -5.5116645286636298e-17,
                     1.7934455841899695e-17,
                     3.1440920099573752e-17,
                     5.5824896210666650e-17,
                     5.0359708254856147e-17,
                     -1.2811600576905685e-17,
                     9.9612835020910053e-17,
                     1.6937067205052129e-16,
                     5.3400745976558578e-17,
                     -1.9650355151977425e-17,
                     1.3314331442923355e-17,
                     -4.8393304455983036e-17,
                     -5.4848212355065903e-17,
                     8.3230964766959359e-18,
                     5.4979832653832506e-17,
                     -8.1914761779293406e-18,
                     -1.3445951741689944e-17,
                     4.8261684157216451e-17,
                     4.3851791804085930e-15,
                     -2.1384036846895910e-16,
                     -2.5455844122715678e+01,
                     -4.4879393117453526e-15,
                     5.6327769140987013e-16,
                     2.5455844122715678e+01,
                     4.4340470612256841e-18,
                     2.8241152639666221e-15,
                     9.4567579235261414e-16,
                     -4.4340470612269159e-18,
                     1.9082217199802822e-15,
                     1.5822812506773240e-15,
                     3.8869328414934168e-15,
                     4.0109249445126226e-16,
                     -2.5455844122715678e+01,
                     -3.9896929728301764e-15,
                     -3.7428844798095942e-16,
                     2.5455844122715678e+01,
                     2.0552026267352049e-16,
                     -4.6079968759173315e-16,
                     -2.5153875450619836e-14,
                     -1.3396071319878390e-14,
                     4.6576996391354533e-17,
                     3.4349530096620508e-17,
                     1.4021929314952350e-17,
                     3.1688139591720212e-17,
                     5.3307025596397466e-17,
                     4.0763670584623616e-17,
                     2.0751958519995286e-17,
                     3.8102280079723314e-17,
                     5.6348639060044502e-17,
                     -8.4046237719972475e-17,
                     2.7564225490764171e-16,
                     2.2722332334930818e-16,
                     -6.0234127083892578e-17,
                     -1.6696452640823461e-16,
                     1.6814916619589534e-16,
                     2.3828774219885164e-16,
                     6.6088818815314301e-17,
                     -7.4541507512911433e-17,
                     2.9876249938498712e-16,
                     2.5057901737486226e-16,
                     -5.0493947328622785e-17,
                     -1.5745979620117364e-16,
                     1.9126941067324065e-16,
                     2.6164343622440572e-16,
                     -5.8862387052195417e-20,
                     5.8862387052188977e-20,
                     5.8862387052191047e-20,
                     -5.8862387052183777e-20,
                     -5.8862387052186750e-20,
                     5.8862387052186654e-20,
                     5.8862387052186967e-20,
                     -5.8862387052189230e-20,
                     8.9999999999999947e+00,
                     1.1536905285934398e-15,
                     -7.1096297232267736e-15,
                     8.9999999999999964e+00,
                     2.3779698460709835e-16,
                     -7.2549544946344632e-15,
                     -4.7631495472022970e-17,
                     -8.0985539993141331e-32,
                     2.8241152639666241e-15,
                     4.7631495472022151e-17,
                     -4.3111051893216086e-32,
                     1.9082217199802853e-15,
                     -2.6875955948030988e-17,
                     -9.4446508193215348e-32,
                     1.0524532420174271e-15,
                     2.6875955948030587e-17,
                     -5.8386204017765573e-32,
                     9.0712847060974243e-16,
                     -1.8000000000000000e+01,
                     4.9500102118818144e-15,
                     2.7930312722383164e-15,
                     -3.3643359770382864e-14,
                     1.3039150243390720e-16,
                     -1.3217728271772626e-16,
                     -4.2756886556271743e-16,
                     4.6774027106911620e-16,
                     1.6288801020469502e-16,
                     -2.0305941571109388e-16,
                     -1.7918060019575468e-16,
                     1.8096638047957356e-16,
                     9.8287247608509965e-18,
                     -9.8287247608511074e-18,
                     -1.2801120535997660e-16,
                     -7.2797529741373678e-16,
                     9.8287247608511321e-18,
                     -9.8287247608510766e-18,
                     8.7272845823203370e-16,
                     5.2646767453987980e-16,
                     -9.8287247608511798e-18,
                     9.8287247608509580e-18,
                     -3.7507966106119017e-16,
                     -1.1802415845486356e-15,
                     -9.8287247608510812e-18,
                     9.8287247608510026e-18,
                     1.0842775214921854e-15,
                     6.8894401920425892e-16,
                     -2.6230948727376875e-16,
                     1.1322475507549313e-16,
                     1.5741652279822451e-16,
                     -2.1811771955103744e-16,
                     -6.7917828911292348e-16,
                     2.8670403615469265e-16,
                     7.8407125358846792e-16,
                     -1.8181107167914819e-16,
                     -2.3031375133549029e-16,
                     7.2272089880494256e-14,
                     2.9819322936594288e-30,
                     2.3031375133546337e-16,
                     8.2610789426874690e-14,
                     4.0819007395086338e-30,
                     -5.1961524227066043e+01,
                     -3.6718569077415120e-15,
                     -1.7282611387948641e-14,
                     5.1961524227066057e+01,
                     2.5032968533813678e-14,
                     -2.2601584564308985e-15,
                     2.5174311474131338e-16,
                     -3.8709622166531944e-14,
                     -4.1817254640081643e-30,
                     -2.5174311474130160e-16,
                     -3.8731817487152555e-14,
                     -2.3856510353198190e-30,
                     -1.0061787483269605e-14,
                     -1.0799999999999941e+03,
                     -2.6161911911255157e-14,
                     2.3934907139690109e-14,
                     -2.1650635094610943e-01,
                     -2.1650635094610962e-01,
                     2.1650635094610968e-01,
                     2.1650635094610945e-01,
                     -2.1650635094610921e-01,
                     -2.1650635094610937e-01,
                     2.1650635094610962e-01,
                     2.1650635094610945e-01,
                     -3.4681048496117736e-16,
                     -4.5578481813958930e-16,
                     -6.7421098162625489e-16,
                     -3.1519252241837389e-16,
                     4.0626545005472454e-16,
                     3.4257349823652809e-16,
                     -3.7316718384508157e-16,
                     -5.8498116845081896e-16,
                     -3.9361077782274519e-16,
                     -6.3103903875345291e-16,
                     -5.9834572533771109e-16,
                     -3.0420013825885591e-16,
                     5.9136583749244039e-16,
                     3.0270902391179288e-16,
                     -3.0279070105474554e-16,
                     -4.3676944683610403e-16,
                     -1.0825317547305464e+00,
                     -1.0825317547305453e+00,
                     -1.0825317547305471e+00,
                     -1.0825317547305471e+00,
                     1.0825317547305486e+00,
                     1.0825317547305489e+00,
                     1.0825317547305482e+00,
                     1.0825317547305471e+00,
                     2.8773070104780652e-17,
                     -1.6144655270623903e-15,
                     7.3343115606318246e-14,
                     -2.8773070104808842e-17,
                     -1.5680395567273896e-15,
                     8.1539763701051546e-14,
                     -3.9907491102018403e-14,
                     2.2045407685048616e+02,
                     -2.8038982619013984e-14,
                     -3.1555471503528226e-14,
                     2.2045407685048616e+02,
                     -2.7992556648678978e-14,
                     5.1961524227066596e+00,
                     1.0811935769445839e-13,
                     -3.2619502414924330e-15,
                     -5.1961524227066569e+00,
                     -1.0226317943999463e-13,
                     4.1247988303941036e-15,
                     -3.2945666106044801e-15,
                     -8.1760303237325622e-14,
                     -5.4000000000000057e+02,
                     -2.9901851586743996e-15,
                     -2.1650635094610929e-01,
                     2.1650635094610912e-01,
                     2.1650635094611009e-01,
                     -2.1650635094611004e-01,
                     -2.1650635094610884e-01,
                     2.1650635094610890e-01,
                     2.1650635094610973e-01,
                     -2.1650635094610970e-01,
                     -2.6676769318526652e-16,
                     -3.7494771947891445e-16,
                     4.2592347308224933e-18,
                     5.9392666956170521e-16,
                     -3.9217073902378782e-16,
                     -3.5215388086582331e-16,
                     -6.6652046456031747e-16,
                     -3.7821751519956494e-17,
                     -3.1588104224502731e-16,
                     -3.5040912690478395e-16,
                     -2.2128864877480579e-16,
                     9.2861952432541201e-17,
                     -1.3940154568211580e-16,
                     -3.4408160878631636e-16,
                     -8.3693984524331426e-17,
                     2.3045661668301553e-16,
                     -1.0825317547305477e+00,
                     -1.0825317547305471e+00,
                     1.0825317547305473e+00,
                     1.0825317547305471e+00,
                     1.0825317547305495e+00,
                     1.0825317547305484e+00,
                     -1.0825317547305489e+00,
                     -1.0825317547305482e+00,
                     -7.3351866781548525e-17,
                     7.9831324127840546e-15,
                     -1.6144655270623928e-15,
                     7.3351866781545739e-17,
                     1.1377227500637141e-14,
                     -1.5680395567273885e-15,
                     5.1961524227066667e+00,
                     9.4487108234318333e-14,
                     -8.7551883093433921e-15,
                     -5.1961524227066622e+00,
                     -8.8630929979854569e-14,
                     1.0622215205291005e-14,
                     -2.8739711416868094e-14,
                     2.2045407685048590e+02,
                     1.4659546864689056e-16,
                     -3.7215449227659486e-14,
                     2.2045407685048593e+02,
                     -4.1979973595844001e-15,
                     -8.3316151219359061e-15,
                     -5.4000000000000000e+02,
                     9.1293569387124442e-14,
                     7.6229496057397810e-15,
                     -4.5095928829170156e-16,
                     -1.7033520664043029e-16,
                     1.9662139908297841e-16,
                     2.4604301457680117e-16,
                     -5.5133015573620837e-17,
                     -2.2652737547206209e-16,
                     8.0162145301660830e-17,
                     1.5325902242378361e-16,
                     -3.7275724907456920e-17,
                     8.3759025352673188e-16,
                     8.0889289128367770e-18,
                     -8.0889289128369789e-18,
                     -6.5661568674584976e-16,
                     8.6519727731350900e-17,
                     8.0889289128368109e-18,
                     -8.0889289128369188e-18,
                     1.2664794087689425e-15,
                     3.1355087391579818e-16,
                     -8.0889289128369034e-18,
                     8.0889289128368880e-18,
                     -3.3352141808258412e-16,
                     -1.3889070582356081e-15,
                     -8.0889289128368664e-18,
                     8.0889289128368341e-18,
                     -1.9452487203770566e-15,
                     -1.2167500352284100e-15,
                     -1.8115118072851969e-15,
                     -2.2277602667580196e-15,
                     1.5241213511280486e-15,
                     1.4719944720871361e-15,
                     1.4422557927922758e-15,
                     9.6258150622905129e-16,
                     3.0335219788502313e-16,
                     -3.6679014192022438e-31,
                     -4.3535042541127556e-14,
                     -3.0335219788500863e-16,
                     -1.4145478887058492e-30,
                     -3.3906397112556892e-14,
                     -3.0332744050332487e-16,
                     -1.5983056564934986e-15,
                     6.4924403303268313e-30,
                     3.0332744050332462e-16,
                     1.5983056564934722e-15,
                     5.0229792717084038e-30,
                     -5.1961524227066015e+01,
                     2.7374131178075361e-14,
                     4.1154344980092225e-14,
                     5.1961524227066050e+01,
                     -1.0958537523822218e-14,
                     -6.5149260028506896e-15,
                     2.0747563823225636e-15,
                     3.1522712296894887e-14,
                     -1.0799999999999941e+03,
                     -3.1525285159472204e-14,
                     -2.1650635094610898e-01,
                     -2.1650635094610929e-01,
                     -2.1650635094610948e-01,
                     -2.1650635094610937e-01,
                     2.1650635094610929e-01,
                     2.1650635094610959e-01,
                     2.1650635094610934e-01,
                     2.1650635094610926e-01,
                     -4.1723143387646803e-16,
                     -5.7550056062697006e-16,
                     -1.0825317547305475e+00,
                     -1.0825317547305466e+00,
                     -6.5754979968307981e-16,
                     -4.1818777967452245e-16,
                     -1.0825317547305451e+00,
                     -1.0825317547305466e+00,
                     4.1299444715181866e-16,
                     5.7126357390232055e-16,
                     1.0825317547305480e+00,
                     1.0825317547305484e+00,
                     6.6178678640773001e-16,
                     4.2242476639917246e-16,
                     1.0825317547305464e+00,
                     1.0825317547305473e+00,
                     -3.6415815062416092e-16,
                     -1.9066141259409949e-16,
                     -3.9006683761778859e-16,
                     -1.4641678978405217e-16,
                     -2.6145140585110795e-17,
                     5.1298061226312634e-17,
                     -7.0389763395158558e-17,
                     7.7206748219940551e-17,
                     5.1961524227065850e+00,
                     1.1477179841837413e-13,
                     -1.3529012130654895e-15,
                     -5.1961524227065796e+00,
                     -1.0894223453420561e-13,
                     2.2157498019671037e-15,
                     -3.4948060902032091e-14,
                     3.0345619916301963e-14,
                     2.2045407685048593e+02,
                     -4.3347540454776419e-14,
                     3.0950863113696464e-14,
                     2.2045407685048593e+02,
                     2.8773070104769781e-17,
                     6.3089184927655494e-16,
                     9.4612524548166380e-14,
                     -2.8773070104808663e-17,
                     1.2361350466710645e-15,
                     9.8991074586045863e-14,
                     -6.7142832201131330e-15,
                     6.2378361333923124e-14,
                     -2.9901851586744185e-15,
                     -5.4000000000000182e+02,
                     -2.5980762113533142e+00,
                     2.5980762113533129e+00,
                     -2.5980762113533129e+00,
                     2.5980762113533133e+00,
                     2.5980762113533147e+00,
                     -2.5980762113533120e+00,
                     2.5980762113533111e+00,
                     -2.5980762113533129e+00,
                     -1.9364916731037070e+00,
                     1.9364916731037065e+00,
                     1.9364916731037074e+00,
                     -1.9364916731037054e+00,
                     -1.9364916731037041e+00,
                     1.9364916731037065e+00,
                     1.9364916731037061e+00,
                     -1.9364916731037081e+00,
                     1.9364916731037054e+00,
                     -1.9364916731037056e+00,
                     -1.9364916731037061e+00,
                     1.9364916731037052e+00,
                     1.9364916731037045e+00,
                     -1.9364916731037054e+00,
                     -1.9364916731037056e+00,
                     1.9364916731037063e+00,
                     -1.9364916731037050e+00,
                     1.9364916731037056e+00,
                     1.9364916731037056e+00,
                     -1.9364916731037050e+00,
                     -1.9364916731037070e+00,
                     1.9364916731037045e+00,
                     1.9364916731037065e+00,
                     -1.9364916731037054e+00,
                     5.8755563610706168e-16,
                     6.8280622153773264e-14,
                     4.6470097183644053e-14,
                     -5.6129314134942460e-16,
                     -6.3645363641192247e-14,
                     -5.7342062824979381e-14,
                     1.5841941783236453e-16,
                     5.1250658438777288e-14,
                     3.0380281120199694e-14,
                     8.5159914515644079e-17,
                     -4.8660864387096741e-14,
                     -3.6769395358315863e-14,
                     4.0999826808676453e-17,
                     6.9445811634002183e-14,
                     5.5295488361257779e-14,
                     3.0137742850707166e-16,
                     -6.6155911986618669e-14,
                     -4.8516671647365642e-14,
                     -6.1221908242139345e-16,
                     3.4494812040694427e-15,
                     -6.8350879775115690e-16,
                     1.9269297488762203e-14,
                     -2.1650635094610901e-01,
                     -2.1650635094610887e-01,
                     -2.1650635094610937e-01,
                     -2.1650635094610959e-01,
                     2.1650635094610937e-01,
                     2.1650635094610918e-01,
                     2.1650635094610940e-01,
                     2.1650635094610993e-01,
                     -1.0825317547305455e+00,
                     -1.0825317547305446e+00,
                     -2.2150683469323061e-16,
                     -9.7504603966545007e-16,
                     -1.0825317547305466e+00,
                     -1.0825317547305455e+00,
                     -5.6773885846707912e-16,
                     -2.5253000707645060e-16,
                     1.0825317547305464e+00,
                     1.0825317547305455e+00,
                     2.3067480260144079e-16,
                     9.8421400757366042e-16,
                     1.0825317547305473e+00,
                     1.0825317547305462e+00,
                     5.5857089055886985e-16,
                     2.4336203916824109e-16,
                     2.6582923508907451e-17,
                     5.0290095033900378e-16,
                     4.8512479859798059e-16,
                     -8.9991151199857017e-17,
                     3.6432526237783819e-16,
                     1.2710273444091230e-16,
                     2.4367680914967685e-16,
                     5.5774216606151280e-16,
                     5.1961524227066338e+00,
                     4.0233944715279889e-15,
                     1.2105071895666357e-13,
                     -5.1961524227066311e+00,
                     -2.1563675755803733e-15,
                     -1.1430152599570160e-13,
                     -7.3351866781562614e-17,
                     2.1612854737563750e-16,
                     9.4076020137448081e-14,
                     7.3351866781527916e-17,
                     6.4672004152606116e-16,
                     9.9527578996764301e-14,
                     -4.9671872477469910e-14,
                     5.2237352650187307e-15,
                     2.2045407685048559e+02,
                     -3.8236023702526516e-14,
                     3.3822697004292541e-17,
                     2.2045407685048565e+02,
                     4.3618811298785300e-15,
                     7.6229496057398078e-15,
                     -1.0389866432743164e-13,
                     -5.4000000000000023e+02,
                     -2.1650635094610918e-01,
                     2.1650635094610909e-01,
                     2.1650635094610932e-01,
                     -2.1650635094610940e-01,
                     -2.1650635094610940e-01,
                     2.1650635094610932e-01,
                     2.1650635094610948e-01,
                     -2.1650635094610957e-01,
                     -3.8395338642466099e-16,
                     -3.0361777914494291e-16,
                     1.0825317547305471e+00,
                     1.0825317547305469e+00,
                     -1.4465206861989619e-16,
                     -3.0582249526132418e-16,
                     -1.0825317547305466e+00,
                     -1.0825317547305473e+00,
                     -3.4933754621881171e-16,
                     -3.1989768353437237e-16,
                     1.0825317547305469e+00,
                     1.0825317547305475e+00,
                     -1.1003622841404689e-16,
                     -3.2210239965075373e-16,
                     -1.0825317547305475e+00,
                     -1.0825317547305466e+00,
                     3.4549175755776468e-16,
                     2.5190185461302110e-16,
                     -3.2986418168340066e-16,
                     -2.3627427873865708e-16,
                     -2.0612395897866234e-16,
                     -5.4967926979012007e-17,
                     1.9049638310429839e-16,
                     3.9340351104647984e-17,
                     -3.9278586051491135e-14,
                     2.2045407685048582e+02,
                     -1.8205248905758501e-15,
                     -3.6279006441336652e-14,
                     2.2045407685048582e+02,
                     -1.2152816931813425e-15,
                     5.1961524227066205e+00,
                     6.6842988533853812e-15,
                     6.3489383156771255e-14,
                     -5.1961524227066205e+00,
                     -9.8668039371751658e-15,
                     -5.7659819272602730e-14,
                     -6.9143613569188264e-17,
                     9.1249046570964290e-15,
                     6.3089184927655109e-16,
                     6.9143613569184973e-17,
                     1.0235455256324765e-14,
                     1.2361350466710635e-15,
                     5.2157843616782051e-15,
                     -5.4000000000000057e+02,
                     7.1856151032444014e-15,
                     -5.6084136437822705e-14,
                     -2.1650635094610879e-01,
                     -2.1650635094610915e-01,
                     2.1650635094610926e-01,
                     2.1650635094610926e-01,
                     -2.1650635094610962e-01,
                     -2.1650635094610923e-01,
                     2.1650635094610937e-01,
                     2.1650635094611012e-01,
                     -1.0825317547305442e+00,
                     -1.0825317547305444e+00,
                     3.6212693934826904e-16,
                     1.4737606664223873e-16,
                     1.0825317547305457e+00,
                     1.0825317547305464e+00,
                     2.7376689274422076e-16,
                     2.3740115872994579e-16,
                     -1.0825317547305446e+00,
                     -1.0825317547305460e+00,
                     4.2605172827728124e-16,
                     9.1925251162525619e-17,
                     1.0825317547305471e+00,
                     1.0825317547305464e+00,
                     3.3769168167323301e-16,
                     1.8195034325023265e-16,
                     -9.6611914894911962e-17,
                     -5.0967762752903192e-16,
                     -1.8728823547209554e-16,
                     -8.4392349126648530e-16,
                     1.7166065959773211e-16,
                     8.2829591539212206e-16,
                     1.1223949076927674e-16,
                     5.2530520340339673e-16,
                     -3.4213269762393301e-14,
                     2.3065382557271776e-15,
                     2.2045407685048565e+02,
                     -4.7618099884038228e-14,
                     2.7371297498775984e-15,
                     2.2045407685048565e+02,
                     -6.9143613569200824e-17,
                     7.7629370357270112e-14,
                     2.1612854737558844e-16,
                     6.9143613569175531e-17,
                     7.7253508950099857e-14,
                     6.4672004152600969e-16,
                     5.1961524227066604e+00,
                     4.4123386149025075e-15,
                     1.2263081286531224e-13,
                     -5.1961524227066587e+00,
                     -7.5948436986923000e-15,
                     -1.1588161990435027e-13,
                     2.0077534126731784e-15,
                     7.1856151032443714e-15,
                     -5.3999999999999955e+02,
                     1.3234949648335055e-13,
                     -4.8156758087047251e-16,
                     -5.0624263312554228e-16,
                     -3.4108125212989036e-16,
                     -4.6266270482165395e-16,
                     5.0696418452017160e-16,
                     5.5658171801321057e-16,
                     3.1568464848019141e-16,
                     4.1232361993398595e-16,
                     -4.1248020835547223e-16,
                     2.4106168599828598e-16,
                     -2.5930404865685820e-15,
                     -2.4952302753898883e-15,
                     -5.5381534766197523e-17,
                     9.5432077324904804e-16,
                     -1.8601343961453887e-15,
                     -2.4014613656468990e-15,
                     6.0181942969888902e-16,
                     -5.1722464654869248e-17,
                     2.6553966896635058e-15,
                     2.5575864784848132e-15,
                     -1.3395768657721934e-16,
                     -1.1436599945924649e-15,
                     1.7977781930504673e-15,
                     2.3391051625519772e-15,
                     1.4752737156052962e-17,
                     -1.4752737156053323e-17,
                     -1.4752737156053563e-17,
                     1.4752737156053190e-17,
                     1.4752737156053317e-17,
                     -1.4752737156053280e-17,
                     -1.4752737156053320e-17,
                     1.4752737156053412e-17,
                     -5.1961524227066086e+01,
                     2.1805368508264264e-15,
                     2.7676002605642255e-15,
                     5.1961524227066100e+01,
                     1.0518101437723630e-14,
                     -4.1325917899239341e-14,
                     1.4965488742778223e-16,
                     2.1197135344450948e-29,
                     2.0265397367538619e-13,
                     -1.4965488742785567e-16,
                     2.3121968201879780e-29,
                     2.1036703781093198e-13,
                     -4.5441413122421230e-16,
                     1.0497339661768076e-30,
                     3.6568086416867745e-14,
                     4.5441413122419672e-16,
                     2.7326400464554724e-30,
                     4.0873353236816980e-14,
                     -8.4824888889947582e-15,
                     -1.5552592117558514e-14,
                     4.7224101777455220e-14,
                     -1.0799999999999961e+03)
                        .finished();

    return refPiNabla;
}

TEST(Test_VEM_PCC, Test_VEM_PCC_3D_O1_O2_O3)
{

    const std::string exportFolder = "Export/VEM/PCC/Test_VEM_PCC_3D_O1_02_03";
    Gedim::Output::CreateFolder(exportFolder);

    Gedim::GeometryUtilitiesConfig geometry_utilities_config;
    geometry_utilities_config.Tolerance1D = std::numeric_limits<double>::epsilon();
    Gedim::GeometryUtilities geometry_utilities(geometry_utilities_config);

    const Test_VEM_PCC_3D_Polyhedron_Geometry polyhedron_data = Test_VEM_PCC_3D_Geometry(geometry_utilities);

    const unsigned int numFaces = polyhedron_data.PolygonalFaces.size();
    std::vector<Polydim::VEM::PCC::VEM_PCC_2D_Polygon_Geometry> polygonalFaces;

    for (unsigned int f = 0; f < numFaces; f++)
    {
        polygonalFaces.push_back({geometry_utilities_config.Tolerance1D,
                                  geometry_utilities_config.Tolerance2D,
                                  polyhedron_data.PolygonalFaces[f].Vertices,
                                  polyhedron_data.PolygonalFaces[f].Centroid,
                                  polyhedron_data.PolygonalFaces[f].Measure,
                                  polyhedron_data.PolygonalFaces[f].Diameter,
                                  polyhedron_data.PolygonalFaces[f].TriangulationVertices,
                                  polyhedron_data.PolygonalFaces[f].EdgesLength,
                                  polyhedron_data.PolygonalFaces[f].EdgesDirection,
                                  polyhedron_data.PolygonalFaces[f].EdgesTangent,
                                  polyhedron_data.PolygonalFaces[f].EdgesNormal});
    }

    Polydim::VEM::PCC::VEM_PCC_3D_Polyhedron_Geometry polyhedron = {geometry_utilities_config.Tolerance1D,
                                                                    geometry_utilities_config.Tolerance2D,
                                                                    geometry_utilities_config.Tolerance3D,

                                                                    polyhedron_data.Vertices,

                                                                    polyhedron_data.Edges,
                                                                    polyhedron_data.Faces,
                                                                    polyhedron_data.Centroid,
                                                                    polyhedron_data.Measure,
                                                                    polyhedron_data.Diameter,
                                                                    polyhedron_data.TetrahedronVertices,

                                                                    polyhedron_data.FacesRotationMatrix,
                                                                    polyhedron_data.FacesTranslation,
                                                                    polyhedron_data.FacesNormals,
                                                                    polyhedron_data.FacesNormalDirection,

                                                                    polyhedron_data.EdgesDirection,
                                                                    polyhedron_data.EdgesTangent,

                                                                    polygonalFaces};

    for (unsigned int k = 1; k < 4; k++)
    {
        Polydim::VEM::PCC::VEM_PCC_2D_ReferenceElement vem_reference_element_2D;
        Polydim::VEM::PCC::VEM_PCC_3D_ReferenceElement vem_reference_element_3D;
        Polydim::VEM::PCC::VEM_PCC_3D_LocalSpace vem_local_space;

        const auto reference_element_data_2D = vem_reference_element_2D.Create(k);
        const auto reference_element_data_3D = vem_reference_element_3D.Create(k);
        const auto local_space = vem_local_space.CreateLocalSpace(reference_element_data_2D, reference_element_data_3D, polyhedron);

        // Export domain
        {
            Gedim::VTKUtilities vtkUtilities;
            vtkUtilities.AddPolyhedron(polyhedron.Vertices, polyhedron.Edges, polyhedron.Faces);
            vtkUtilities.Export(exportFolder + "/Polyhedron.vtu");

            Test_VEM_PCC_3D_Export_Dofs(polyhedron, polygonalFaces, reference_element_data_3D, exportFolder);
        }

        // Test Reference PiNabla

        const auto refPiNabla = Test_VEM_PCC_3D_RefPiNabla()[k - 1];
        const double relErrPiNabla = (local_space.PiNabla - refPiNabla).norm() / refPiNabla.norm();
        ASSERT_TRUE(relErrPiNabla < 1.0e-12);

        // Test VEM performances
        Polydim::VEM::PCC::VEM_PCC_PerformanceAnalysis performanceAnalysis;

        const auto result =
            performanceAnalysis.Compute(Polydim::Utilities::Monomials_3D(), reference_element_data_3D.Monomials, vem_local_space, local_space);

        ASSERT_TRUE(result.ErrorPiNabla < 1.0e-12);
        ASSERT_TRUE(result.ErrorPi0km1 < 1.0e-12);
        ASSERT_TRUE(result.ErrorPi0k < 1.0e-12);
        ASSERT_EQ(result.ErrorPi0km1Grad.size(), 3);
        for (unsigned int d = 0; d < 3; ++d)
            ASSERT_TRUE(result.ErrorPi0km1Grad[d] < 1.0e-11);
        ASSERT_TRUE(result.ErrorStabilization < 1.0e-11);
    }
}

} // namespace UnitTesting
} // namespace Polydim

#endif
